<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Risk Right - Position Size Calculator</title>

    <!-- PWA and Mobile Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Risk Right">
    <meta name="theme-color" content="#2d3748">

    <!-- Embedded Manifest and Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20192%20192'%20width='192'%20height='192'%3E%3Cdefs%3E%3Cstyle%3E.bg%20%7B%20fill:%20%232d3748;%20%7D%20.text%20%7B%20fill:%20%23ffffff;%20font-family:%20Arial,%20sans-serif;%20font-size:%2080px;%20font-weight:%20bold;%20text-anchor:%20middle;%20%7D%3C/style%3E%3C/defs%3E%3Crect%20class='bg'%20width='192'%20height='192'%20rx='32'/%3E%3Ctext%20x='96'%20y='120'%20class='text'%3ERR%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20192%20192'%20width='192'%20height='192'%3E%3Cdefs%3E%3Cstyle%3E.bg%20%7B%20fill:%20%232d3748;%20%7D%20.text%20%7B%20fill:%20%23ffffff;%20font-family:%20Arial,%20sans-serif;%20font-size:%2080px;%20font-weight:%20bold;%20text-anchor:%20middle;%20%7D%3C/style%3E%3C/defs%3E%3Crect%20class='bg'%20width='192'%20height='192'%20rx='32'/%3E%3Ctext%20x='96'%20y='120'%20class='text'%3ERR%3C/text%3E%3C/svg%3E">
    <link rel="manifest" href="data:application/json,%7B%22name%22%3A%22Risk%20Right%22%2C%22short_name%22%3A%22Risk%20Right%22%2C%22description%22%3A%22Position%20Size%20Calculator%22%2C%22start_url%22%3A%22/%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%23ffffff%22%2C%22theme_color%22%3A%22%231a73e8%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage/svg%2Bxml%2C%253Csvg%2520xmlns%3D'http%3A//www.w3.org/2000/svg'%2520viewBox%3D'0%25200%2520192%2520192'%2520width%3D'192'%2520height%3D'192'%253E%253Cdefs%253E%253Cstyle%253E.bg%2520%257B%2520fill%3A%2520%25232d3748%3B%2520%257D%2520.text%2520%257B%2520fill%3A%2520%2523ffffff%3B%2520font-family%3A%2520Arial%2C%2520sans-serif%3B%2520font-size%3A%252080px%3B%2520font-weight%3A%2520bold%3B%2520text-anchor%3A%2520middle%3B%2520%257D%253C/style%253E%253C/defs%253E%253Crect%2520class%3D'bg'%2520width%3D'192'%2520height%3D'192'%2520rx%3D'32'/%253E%253Ctext%2520x%3D'96'%2520y%3D'120'%2520class%3D'text'%253ERR%253C/text%253E%253C/svg%253E%22%2C%22sizes%22%3A%22192x192%20512x512%22%2C%22type%22%3A%22image/svg%2Bxml%22%2C%22purpose%22%3A%22any%22%7D%5D%7D">

    <!-- Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
      /* Simple fade-in animation for consistency with the previous version */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
      }
      .animate-fade-in {
        animation: fadeIn 0.3s ease-out forwards;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-white font-sans">
    <div id="root" class="min-h-screen flex flex-col items-center justify-center p-4">
      <div class="w-full max-w-md mx-auto">
        <header class="text-center mb-8">
          <h1 class="text-4xl font-bold text-white">Risk Right</h1>
          <p class="text-lg text-gray-400 mt-2">Precision Position Size Calculator</p>
        </header>

        <main class="bg-gray-800 rounded-xl shadow-2xl p-6 space-y-6">
          <!-- Symbol Search -->
          <div id="search-container" class="relative">
            <label for="symbol-search" class="block text-sm font-medium text-gray-300 mb-1">Symbol / Currency Pair</label>
            <div class="relative">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
              </svg>
              <input id="symbol-search" type="text" placeholder="e.g., 'AAPL' or 'Apple' or 'EUR/USD'" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 pl-10 pr-4 text-white focus:outline-none transition-all duration-300 focus:ring-2 focus:ring-green-500 focus:border-green-500" autocomplete="off">
            </div>
            <ul id="search-results" class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-700 rounded-md shadow-lg max-h-60 overflow-y-auto hidden"></ul>
            <p id="symbol-error" class="text-red-400 text-sm mt-1 animate-fade-in hidden"></p>
          </div>

          <!-- Entry & Stop Loss -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="entry-price" class="block text-sm font-medium text-gray-300 mb-1">Entry Price</label>
              <input id="entry-price" type="number" placeholder="e.g., 172.45" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
            </div>
            <div>
              <label for="stop-loss" class="block text-sm font-medium text-gray-300 mb-1">Stop Loss</label>
              <input id="stop-loss" type="number" placeholder="e.g., 170.00" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500">
            </div>
          </div>

          <!-- Risk Amount & Currency -->
          <div class="grid grid-cols-2 gap-4">
            <div class="relative">
              <label for="risk-amount" class="block text-sm font-medium text-gray-300 mb-1">Risk Amount</label>
              <div class="absolute inset-y-0 left-0 top-6 pl-3 flex items-center pointer-events-none">
                <span id="risk-currency-symbol" class="text-gray-400 sm:text-sm">$</span>
              </div>
              <input type="number" id="risk-amount" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 pl-8 pr-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500" placeholder="e.g., 50">
            </div>
            <div>
              <label for="risk-currency" class="block text-sm font-medium text-gray-300 mb-1">Currency</label>
              <select id="risk-currency" class="w-full bg-gray-700 border border-gray-600 rounded-md shadow-sm py-2 px-3 text-white focus:outline-none focus:ring-2 focus:ring-green-500 focus:border-green-500"></select>
            </div>
          </div>

          <!-- Calculate Button -->
          <div>
            <button id="calculate-btn" disabled class="w-full flex justify-center py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-green-500 disabled:bg-gray-600 disabled:cursor-not-allowed transition-colors">Calculate</button>
          </div>

          <!-- Result Display -->
          <div class="pt-4">
            <div id="result-display" class="text-center p-6 bg-gray-800 rounded-lg">
              <p class="text-gray-400">Your calculated position size will appear here.</p>
            </div>
          </div>
        </main>

        <footer class="text-center mt-8 text-gray-500 text-sm">
          <p id="footer-year"></p>
        </footer>
      </div>
    </div>
    
    <!-- Application JavaScript -->
    <script>
// --- DATA & TYPES ---
const AssetType = {
  Stock: 'Stock',
  Forex: 'Forex',
  Crypto: 'Crypto',
  Commodity: 'Commodity',
};

const CURRENCIES = [
  { code: 'USD', symbol: '$' },
  { code: 'EUR', symbol: '€' },
  { code: 'GBP', symbol: '£' },
  { code: 'AED', symbol: 'د.إ' },
  { code: 'JPY', symbol: '¥' },
];

const usStocks = [
  { symbol: 'AAPL', name: 'Apple Inc.', type: AssetType.Stock, price: 178.50 },
  { symbol: 'TSLA', name: 'Tesla, Inc.', type: AssetType.Stock, price: 185.30 },
  { symbol: 'MSFT', name: 'Microsoft Corporation', type: AssetType.Stock, price: 425.10 },
  { symbol: 'GOOGL', name: 'Alphabet Inc.', type: AssetType.Stock, price: 175.88 },
  { symbol: 'AMZN', name: 'Amazon.com, Inc.', type: AssetType.Stock, price: 184.67 },
  { symbol: 'META', name: 'Meta Platforms, Inc.', type: AssetType.Stock, price: 498.71 },
  { symbol: 'NVDA', name: 'NVIDIA Corporation', type: AssetType.Stock, price: 905.25 },
  { symbol: 'NFLX', name: 'Netflix, Inc.', type: AssetType.Stock, price: 610.15 },
  { symbol: 'AMD', name: 'Advanced Micro Devices, Inc.', type: AssetType.Stock, price: 162.48 },
  { symbol: 'UBER', name: 'Uber Technologies, Inc.', type: AssetType.Stock, price: 70.55 },
  { symbol: 'COIN', name: 'Coinbase Global, Inc.', type: AssetType.Stock, price: 235.80 },
  { symbol: 'DIS', name: 'The Walt Disney Company', type: AssetType.Stock, price: 105.14 },
];
const ukStocks = [
  { symbol: 'LLOY.L', name: 'Lloyds Banking Group', type: AssetType.Stock, price: 52.50 },
  { symbol: 'VOD.L', name: 'Vodafone', type: AssetType.Stock, price: 72.80 },
  { symbol: 'BARC.L', name: 'Barclays', type: AssetType.Stock, price: 205.40 },
  { symbol: 'TSCO.L', name: 'Tesco', type: AssetType.Stock, price: 302.10 },
  { symbol: 'BP.L', name: 'BP', type: AssetType.Stock, price: 485.60 },
  { symbol: 'AZN.L', name: 'AstraZeneca', type: AssetType.Stock, price: 12450.00 },
  { symbol: 'ULVR.L', name: 'Unilever', type: AssetType.Stock, price: 4420.00 },
  { symbol: 'SHEL.L', name: 'Shell', type: AssetType.Stock, price: 2890.00 },
  { symbol: 'HSBA.L', name: 'HSBC', type: AssetType.Stock, price: 680.00 },
  { symbol: 'RIO.L', name: 'Rio Tinto', type: AssetType.Stock, price: 5230.00 },
  { symbol: 'DGE.L', name: 'Diageo', type: AssetType.Stock, price: 2850.00 },
  { symbol: 'GSK.L', name: 'GSK', type: AssetType.Stock, price: 1780.00 },
];
const cryptoCommodities = [
  { symbol: 'BTC/USD', name: 'Bitcoin', type: AssetType.Crypto, price: 65420.75 },
  { symbol: 'ETH/USD', name: 'Ethereum', type: AssetType.Crypto, price: 3450.21 },
  { symbol: 'XAU/USD', name: 'Gold', type: AssetType.Commodity, price: 2355.40 },
  { symbol: 'XAG/USD', name: 'Silver', type: AssetType.Commodity, price: 28.15 },
];
const forexPairs = [
  { symbol: 'EUR/USD', name: 'Euro to US Dollar', type: AssetType.Forex, price: 1.0855 },
  { symbol: 'GBP/USD', name: 'Pound Sterling to US Dollar', type: AssetType.Forex, price: 1.2680 },
  { symbol: 'USD/JPY', name: 'US Dollar to Japanese Yen', type: AssetType.Forex, price: 155.75 },
  { symbol: 'AUD/USD', name: 'Australian Dollar to US Dollar', type: AssetType.Forex, price: 0.6610 },
  { symbol: 'USD/CAD', name: 'US Dollar to Canadian Dollar', type: AssetType.Forex, price: 1.3660 },
  { symbol: 'USD/CHF', name: 'US Dollar to Swiss Franc', type: AssetType.Forex, price: 0.9025 },
  { symbol: 'NZD/USD', name: 'New Zealand Dollar to US Dollar', type: AssetType.Forex, price: 0.6135 },
  { symbol: 'EUR/GBP', name: 'Euro to Pound Sterling', type: AssetType.Forex, price: 0.8560 },
  { symbol: 'EUR/JPY', name: 'Euro to Japanese Yen', type: AssetType.Forex, price: 169.10 },
  { symbol: 'GBP/JPY', name: 'Pound Sterling to Japanese Yen', type: AssetType.Forex, price: 197.50 },
];
const SYMBOLS = [...usStocks, ...ukStocks, ...cryptoCommodities, ...forexPairs].sort((a, b) => a.symbol.localeCompare(b.symbol));

// --- CALCULATION HELPERS ---
const getConversionRate = (fromCurrency, toCurrency) => {
  if (fromCurrency === toCurrency) return 1;
  const directPair = SYMBOLS.find(s => s.symbol === `${fromCurrency}/${toCurrency}`);
  if (directPair) return directPair.price;
  const inversePair = SYMBOLS.find(s => s.symbol === `${toCurrency}/${fromCurrency}`);
  if (inversePair) return 1 / inversePair.price;

  const getRateToUSD = (currency) => {
      if (currency === 'USD') return 1;
      const pairWithUSDQuote = SYMBOLS.find(s => s.symbol === `${currency}/USD`);
      if (pairWithUSDQuote) return pairWithUSDQuote.price;
      const pairWithUSDBase = SYMBOLS.find(s => s.symbol === `USD/${currency}`);
      if (pairWithUSDBase) return 1 / pairWithUSDBase.price;
      return null;
  };

  const fromRate = getRateToUSD(fromCurrency);
  const toRate = getRateToUSD(toCurrency);
  
  if (fromRate && toRate) {
      return fromRate / toRate;
  }
  
  console.warn(`Could not find conversion rate from ${fromCurrency} to ${toCurrency}. Falling back to 1.`);
  return 1;
};

// --- APP INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    // --- APPLICATION STATE ---
    const state = {
        selectedSymbol: null,
        entryPrice: '',
        stopLoss: '',
        riskAmount: '',
        riskCurrency: 'USD',
        positionSize: null,
        assetType: null,
    };
    let filteredResults = [];

    // --- DOM ELEMENTS ---
    const symbolSearchInput = document.getElementById('symbol-search');
    const searchResultsList = document.getElementById('search-results');
    const symbolErrorEl = document.getElementById('symbol-error');
    const searchContainer = document.getElementById('search-container');
    const entryPriceInput = document.getElementById('entry-price');
    const stopLossInput = document.getElementById('stop-loss');
    const riskAmountInput = document.getElementById('risk-amount');
    const riskCurrencySelect = document.getElementById('risk-currency');
    const riskCurrencySymbolSpan = document.getElementById('risk-currency-symbol');
    const calculateBtn = document.getElementById('calculate-btn');
    const resultDisplayContainer = document.getElementById('result-display');
    const footerYearEl = document.getElementById('footer-year');

    // --- RENDER FUNCTIONS ---
    const renderResult = () => {
      resultDisplayContainer.innerHTML = '';
      resultDisplayContainer.className = 'rounded-lg';

      if (state.positionSize === null || state.assetType === null) {
        resultDisplayContainer.classList.add('text-center', 'p-6', 'bg-gray-800');
        resultDisplayContainer.innerHTML = `<p class="text-gray-400">Your calculated position size will appear here.</p>`;
        return;
      }

      if (state.positionSize <= 0) {
        resultDisplayContainer.classList.add('text-center', 'p-6', 'bg-red-900/50', 'border', 'border-red-700');
        resultDisplayContainer.innerHTML = `<p class="font-semibold text-red-300">Invalid calculation. Please check your inputs. Stop Loss and Entry Price cannot be the same.</p>`;
        return;
      }

      const getDisplayDetails = () => {
        switch (state.assetType) {
          case AssetType.Stock: return { unit: 'shares', action: 'Buy' };
          case AssetType.Crypto: return { unit: 'units', action: 'Enter' };
          case AssetType.Forex:
          case AssetType.Commodity:
          default: return { unit: 'lots', action: 'Enter' };
        }
      };

      const { unit, action } = getDisplayDetails();
      const formattedSize = state.positionSize.toFixed(2);
      
      resultDisplayContainer.classList.add('text-center', 'p-8', 'bg-green-900/50', 'border', 'border-green-700', 'animate-fade-in');
      resultDisplayContainer.innerHTML = `
        <p class="text-lg text-green-300 mb-2">${action}</p>
        <p class="text-5xl font-bold text-white tracking-tight">${formattedSize}</p>
        <p class="text-2xl text-green-300 mt-1">${unit}</p>
      `;
    };
    
    const renderSearchResults = (results) => {
        searchResultsList.innerHTML = '';
        if (results.length > 0) {
            results.forEach(symbol => {
                const li = document.createElement('li');
                li.className = "cursor-pointer px-4 py-2 text-sm text-gray-200 hover:bg-green-700";
                li.innerHTML = `<div><span class="font-bold">${symbol.symbol}</span> - <span class="text-gray-400">${symbol.name}</span></div>`;
                li.addEventListener('mousedown', () => handleSymbolSelect(symbol));
                searchResultsList.appendChild(li);
            });
            searchResultsList.classList.remove('hidden');
        } else {
            searchResultsList.classList.add('hidden');
        }
    };

    const updateCalculateButtonState = () => {
        const entry = parseFloat(state.entryPrice);
        const sl = parseFloat(state.stopLoss);
        const risk = parseFloat(state.riskAmount);
        const isFormValid = state.selectedSymbol && state.entryPrice && state.stopLoss && risk > 0 && entry !== sl;
        calculateBtn.disabled = !isFormValid;
    };

    // --- EVENT HANDLERS & LOGIC ---
    const handleSymbolSelect = (symbol) => {
        state.selectedSymbol = symbol;
        state.assetType = symbol ? symbol.type : null;
        state.positionSize = null;
        
        symbolSearchInput.value = symbol ? `${symbol.symbol} - ${symbol.name}` : '';
        entryPriceInput.value = '';
        stopLossInput.value = '';
        state.entryPrice = '';
        state.stopLoss = '';

        searchResultsList.classList.add('hidden');
        symbolErrorEl.classList.add('hidden');
        
        symbolSearchInput.classList.add('ring-2', 'ring-green-500', 'border-transparent');
        setTimeout(() => symbolSearchInput.classList.remove('ring-2', 'ring-green-500', 'border-transparent'), 1000);
        
        renderResult();
        updateCalculateButtonState();
    };

    const handleSymbolNotFound = () => {
        state.selectedSymbol = null;
        state.assetType = null;
        symbolErrorEl.textContent = 'Symbol not found. Please select from the list.';
        symbolErrorEl.classList.remove('hidden');
    };

    const handleCalculate = () => {
        const entry = parseFloat(state.entryPrice);
        const sl = parseFloat(state.stopLoss);
        const risk = parseFloat(state.riskAmount);

        if (isNaN(entry) || isNaN(sl) || isNaN(risk) || risk <= 0 || entry === sl || !state.selectedSymbol) {
            state.positionSize = 0;
            renderResult();
            return;
        }

        const priceDifference = Math.abs(entry - sl);
        let size;
        if (state.assetType === AssetType.Forex) {
            const [, quoteCurrency] = state.selectedSymbol.symbol.split('/');
            const isJpyPair = quoteCurrency === 'JPY';
            const lotSize = 100000;
            const pipSize = isJpyPair ? 0.01 : 0.0001;
            const pipValueInQuoteCurrency = pipSize * lotSize;
            const conversionRate = getConversionRate(quoteCurrency, state.riskCurrency);
            const pipValueInRiskCurrency = pipValueInQuoteCurrency * conversionRate;
            
            if (priceDifference === 0 || pipValueInRiskCurrency === 0) {
                state.positionSize = 0;
                renderResult();
                return;
            }
            const totalRiskPerLot = (priceDifference / pipSize) * pipValueInRiskCurrency;
            size = risk / totalRiskPerLot;

        } else if (state.assetType === AssetType.Commodity && (state.selectedSymbol.symbol.toUpperCase() === 'XAU/USD' || state.selectedSymbol.symbol.toUpperCase() === 'XAG/USD')) {
            if (priceDifference === 0) { state.positionSize = 0; renderResult(); return; }
            const ounces = risk / priceDifference;
            size = ounces / 100;
        } else {
            if (priceDifference === 0) { state.positionSize = 0; renderResult(); return; }
            size = risk / priceDifference;
        }
        state.positionSize = size;
        renderResult();
    };

    const handleSymbolSearchInput = (e) => {
        const query = e.target.value;
        if (query === '' && state.selectedSymbol) {
            state.selectedSymbol = null;
            state.assetType = null;
            state.positionSize = null;
            renderResult();
            updateCalculateButtonState();
        }

        if (query.length > 0) {
            const lowerCaseQuery = query.toLowerCase();
            filteredResults = SYMBOLS.filter(s =>
                s.symbol.toLowerCase().includes(lowerCaseQuery) ||
                s.name.toLowerCase().includes(lowerCaseQuery)
            ).slice(0, 10);
            renderSearchResults(filteredResults);
        } else {
            filteredResults = [];
            renderSearchResults([]);
        }
    };
    
    const handleAutocomplete = () => {
        const query = symbolSearchInput.value;
        if (state.selectedSymbol && query === `${state.selectedSymbol.symbol} - ${state.selectedSymbol.name}`) {
            searchResultsList.classList.add('hidden');
            return;
        }
        if (!query.trim()) {
            if (state.selectedSymbol) {
                 state.selectedSymbol = null;
                 state.assetType = null;
                 state.positionSize = null;
                 renderResult();
                 updateCalculateButtonState();
            }
            searchResultsList.classList.add('hidden');
            return;
        }

        const lowerCaseQuery = query.toLowerCase().trim();
        const formattedForexQuery = lowerCaseQuery.replace(/[\\s/]/g, '');
        let bestMatch;
        bestMatch = SYMBOLS.find(s => s.symbol.toLowerCase() === lowerCaseQuery);
        if (!bestMatch) {
            bestMatch = SYMBOLS.find(s => s.type === AssetType.Forex && s.symbol.replace('/', '').toLowerCase() === formattedForexQuery);
        }
        if (!bestMatch) {
            bestMatch = SYMBOLS.find(s => s.name.toLowerCase() === lowerCaseQuery);
        }
        if (!bestMatch && filteredResults.length > 0) {
            bestMatch = filteredResults[0];
        }

        if (bestMatch) {
            handleSymbolSelect(bestMatch);
        } else {
            handleSymbolNotFound();
        }
        searchResultsList.classList.add('hidden');
    };

    // --- INITIALIZATION ---
    const init = () => {
        // Populate currency dropdown
        CURRENCIES.forEach(({ code }) => {
            const option = document.createElement('option');
            option.value = code;
            option.textContent = code;
            riskCurrencySelect.appendChild(option);
        });

        // Load from localStorage
        const savedRiskAmount = localStorage.getItem('riskright-riskAmount');
        const savedRiskCurrency = localStorage.getItem('riskright-riskCurrency');
        if (savedRiskAmount) {
            riskAmountInput.value = savedRiskAmount;
            state.riskAmount = savedRiskAmount;
        }
        if (savedRiskCurrency && CURRENCIES.some(c => c.code === savedRiskCurrency)) {
            riskCurrencySelect.value = savedRiskCurrency;
            state.riskCurrency = savedRiskCurrency;
        }
        const selectedCurrencyInfo = CURRENCIES.find(c => c.code === state.riskCurrency);
        riskCurrencySymbolSpan.textContent = selectedCurrencyInfo?.symbol || '$';

        footerYearEl.textContent = `© ${new Date().getFullYear()} Risk Right. All Rights Reserved.`;

        // --- Attach Event Listeners ---
        const inputsToTrack = {
          'entry-price': 'entryPrice',
          'stop-loss': 'stopLoss',
          'risk-amount': 'riskAmount'
        };
        Object.keys(inputsToTrack).forEach(id => {
          document.getElementById(id).addEventListener('input', (e) => {
            state[inputsToTrack[id]] = e.target.value;
            updateCalculateButtonState();
          });
        });

        riskCurrencySelect.addEventListener('change', (e) => {
            state.riskCurrency = e.target.value;
            const selectedCurrencyInfo = CURRENCIES.find(c => c.code === state.riskCurrency);
            riskCurrencySymbolSpan.textContent = selectedCurrencyInfo?.symbol || '$';
            localStorage.setItem('riskright-riskCurrency', state.riskCurrency);
            if (state.positionSize !== null) handleCalculate(); // Recalculate if values exist
        });

        riskAmountInput.addEventListener('input', e => {
            localStorage.setItem('riskright-riskAmount', e.target.value);
        });
        
        symbolSearchInput.addEventListener('input', handleSymbolSearchInput);
        symbolSearchInput.addEventListener('focus', () => {
            if (symbolSearchInput.value.length > 0 && !state.selectedSymbol) {
                 handleSymbolSearchInput({ target: { value: symbolSearchInput.value } });
            }
        });
        symbolSearchInput.addEventListener('keydown', e => {
            if (e.key === 'Enter' || e.key === 'Tab') {
                if(symbolSearchInput.value.trim()){
                    e.preventDefault();
                    handleAutocomplete();
                    e.target.blur();
                }
            }
        });
        
        searchContainer.addEventListener('focusout', (e) => {
            if (!searchContainer.contains(e.relatedTarget)) {
                handleAutocomplete();
            }
        });

        calculateBtn.addEventListener('click', handleCalculate);
        updateCalculateButtonState();
    };

    init();
});
    </script>
    
    <!-- Embedded Service Worker Registration -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          const swContent = `
            const CACHE_NAME = 'risk-right-v3-standalone';
            const urlsToCache = [
              '/',
              'https://cdn.tailwindcss.com'
            ];
            self.addEventListener('install', event => {
              event.waitUntil(
                caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
              );
            });
            self.addEventListener('activate', event => {
              const cacheWhitelist = [CACHE_NAME];
              event.waitUntil(
                caches.keys().then(cacheNames => {
                  return Promise.all(
                    cacheNames.map(cacheName => {
                      if (cacheWhitelist.indexOf(cacheName) === -1) {
                        return caches.delete(cacheName);
                      }
                    })
                  );
                })
              );
            });
            self.addEventListener('fetch', event => {
              event.respondWith(
                caches.match(event.request).then(response => {
                  if (response) return response;
                  return fetch(event.request).then(networkResponse => {
                    if(event.request.url.startsWith('http') && event.request.method === 'GET') {
                       caches.open(CACHE_NAME).then(cache => {
                         cache.put(event.request, networkResponse.clone());
                       });
                    }
                    return networkResponse;
                  });
                })
              );
            });
          `;
          const swBlob = new Blob([swContent], {type: 'application/javascript'});
          const swUrl = URL.createObjectURL(swBlob);
          navigator.serviceWorker.register(swUrl)
            .then(registration => console.log('ServiceWorker registration successful with scope: ', registration.scope))
            .catch(err => console.log('ServiceWorker registration failed: ', err));
        });
      }
    </script>
  </body>
</html>

